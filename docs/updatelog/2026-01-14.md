# Update Log (2026-01-14)

## Commit
- `924d554` â€” `addMedator`
- Date: `2026-01-14T16:02:12+08:00`

## Summary
Introduced MediatR to decouple the API controllers from direct EF Core access by moving read operations for `Activity` into `Application` query handlers. The `/api/activities` endpoints keep the same routes, but their internal execution flow now goes through MediatR.

## Changes (High Level)
- API: `ActivitiesController` now delegates to MediatR queries instead of using `AppDbContext` directly.
- API: `BaseApiController` now provides a shared `Mediator` accessor resolved from DI.
- API: MediatR is registered in `Program.cs` and scans the `Application` assembly for handlers.
- Application: added query handlers for listing activities and retrieving activity details.
- Cleanup: removed placeholder `Application/Class1.cs` and the repo-root `package-lock.json`.

## API Changes (Details)

### Controller refactor (no route changes)
- `GET /api/activities`:
  - Before: controller queried EF Core (`context.Activities.ToListAsync()`).
  - Now: controller calls `Mediator.Send(new GetActivityList.Query())`.
- `GET /api/activities/{id}`:
  - Before: controller returned `404 NotFound()` if the activity did not exist.
  - Now: controller calls `Mediator.Send(new GetActivityDetails.Query { Id = id })`.

### Base controller MediatR accessor
`BaseApiController` now resolves `IMediator` via `HttpContext.RequestServices` and exposes it as a protected `Mediator` property, so derived controllers can send requests without constructor injection boilerplate.

### DI/Startup wiring
`API/Program.cs` registers MediatR via:
`builder.Services.AddMediatR(cfg => cfg.RegisterServicesFromAssemblyContaining<GetActivityList.Handler>());`
This scans the `Application` assembly and makes request handlers available to controllers.

## Application Changes (Details)

### Added queries
- `Application/Activities/Queries/GetActivityList.cs`
  - `Query : IRequest<List<Activity>>`
  - `Handler` loads all activities with `ToListAsync(cancellationToken)`.
- `Application/Activities/Queries/GetActivityDetails.cs`
  - `Query : IRequest<Activity>` with required `Id`
  - `Handler` loads an activity by id via `FindAsync([request.Id], cancellationToken)`

### Dependency updates
`Application/Application.csproj` now references:
- `MediatR` (`14.0.0`)

## Behavior Notes / Compatibility
- The routes and response shapes for activity list/detail are intended to remain the same.
- Not-found handling changed:
  - Previously, `GET /api/activities/{id}` returned `404` when missing.
  - Now, `GetActivityDetails.Handler` throws `Exception("Activity not found")`, which will typically produce a `500` response unless you add exception-to-HTTP mapping middleware/filters.

## Verification (Manual)
1. Start API:
   - `dotnet run --project API/API.csproj`
2. Check endpoints:
   - `GET https://localhost:5001/api/activities`
   - `GET https://localhost:5001/api/activities/{id}`

## Follow-ups (Recommended)
- Restore consistent 404 behavior for missing activities by:
  - returning `ActionResult`-friendly results, or
  - throwing a dedicated not-found exception and mapping it to `404` via middleware/filters, or
  - using a result type (e.g., `Result<T>`) across handlers.
